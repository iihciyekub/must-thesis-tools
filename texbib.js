const strokes = "乙丁九刁刀力乜于士才寸大上山千及夕之己弓子王亓井天夫元五支不太友尤巨戈止少中水牛毛壬仁仇仉化仍戶户介公丹勾殳卞六文亢方尹孔巴以允毋玉示邗巧邛功甘世艾古本可丙左石布戊平北占甲申田由史冉生禾丘代仙白他瓜仝令用印卯包市玄永司弘出召皮台母匡刑邢戎圭吉考老芒西在有百成夷光曲同回年朱竹休伍伏延仲仵任仰伊向似行全合兆夙危多次衣亥充羊米汗江汲池汝宇守字安祁那阮羽牟扶抄赤折孝抗却芮花杜巫杞李求孛車车甫束吾豆邴夾夹邶步肖貝贝呂吕別别吳吴岑告利邱何但伯佟位佛佘希邸狂狄彤系言况冷辛汪沐沙沃沈忻完宋宏牢良初罕尾局改阿陀姒邵邰奉武青表長长拓幸招其苦昔茂苗英苟茆苑茅林枝枚析板來来松杭東东奈奇叔歧卓虎尚果昌門门明易昂典呼帖迮牧和季委竺侍岳佴佼依帛卑所金受念瓮朋肥周咎京冼府庚於卷法泣泥波性宗定宜官空宛宓郎房祈建居屈承孟函姓始春封拱城郝荊荆革荀胡茹南柯查相柏柳厙厍威厚郟郏是冒星哈拜郜香秋段修保信皇泉禹侯帥帅俟律後后俞郗俎風风逄昝計计哀度奕施前首洪洛洋宣宦冠軍军祖祝弭韋韦胥姚飛飞盈羿勇柔紅红紀纪泰秦班敖素馬马貢贡袁都盍耿華华恭莫莘晋真莊庄桂桓桐校索軒轩連连速栗夏原柴時时畢毕閃闪晁晏員员剛刚乘秘候倪倫伦隽皋烏乌師师徐殷針针釗钊奚翁卿逢留衷高郭席庫库唐旁旅益烟郯浦酒海浮悟家宮宫容宰書书展陸陆陳陈孫孙陰阴陶姬通能務务桑納纳理堵捷焉赧接聊萇苌萊莱菅乾梅麥麦曹區区堅坚戚盛雪雀堂常眭野閆闫閉闭問问婁娄鄂國国崔崇過过犁笪符第敏偶進进偉伟從从悉脫脱魚鱼象斛祭訥讷許许庹麻庾康鹿章商望牽牵粘清淩凌渠淦淳淡梁寇宿扈逮逯尉屠張张隋將将陽阳隗隆習习貫贯終终紹绍巢貳贰琴琦堯尧塔項项越賁贲揚扬揭喜彭達达斯黃黄葉叶萬万葛董敬葷荤辜植森棟栋惠覃粟雲云斐紫掌戢開开閎闳閔闵遇景貴贵單单喻買买無无智嵇程稅税喬乔答傅集焦鄔邬須须舒鈔钞欽钦鈄钭鈕钮禽舜猶犹貿贸鄒邹馮冯童善普道曾勞劳湛湯汤滑游渾浑惲恽寒富運运祿禄尋寻强費费疏賀贺登瑞載载鄢勢势聖圣蓋盖鄞勤靳蒼苍蒯蓬蒿蒲蒙幹干楚楊杨裘甄賈贾雷零頓顿督訾虞業业睦睢愚路農农節节微徭愈愛爱貊詹解詩诗廉資资裔靖雍義义慈溥源溫温塗涂慎塞褚福辟經经碧趙赵嘉赫壽寿綦慕蔔卜蔡蔚蔣蒋厲厉碩硕爾尔臧裴暢畅聞闻閩闽閭闾鄲郸圖图種种稱称箕管毓僕仆僑侨僧僪銀银鳳凤說说廣广麽么廖竭韶端齊齐旗養养鄭郑榮荣漢汉滿满漆漫賓宾寧宁實实肇禚暨隨随翟翠熊鄧邓緒绪綫线撒駒驹鞏巩穀谷蕢蒉樓楼樊歐欧劇剧輝辉賞赏暴墨稽黎範范儀仪樂乐德衛卫盤盘銳锐劍剑虢餘余滕魯鲁劉刘諸诸諾诺談谈摩褒慶庆翦潜潮潭潘澄遲迟嬀妫練练緱缑駱骆操薑姜燕薛薊蓟薄蕭萧薩萨樹树樸朴橋桥機机賴赖融醜丑勵励曆历霍冀頻频盧卢閻阎蹉戰战穆篤笃興兴學学衡錯错錢钱鮑鲍獨独諶谌諫谏憑凭鄺邝磨龍龙嬴營营澹隱隐璩環环戴聲声鞠藍蓝藏韓韩檢检檀霜戲戏矯矫魏繁儲储禦御鍾锺斂敛鮮鲜謝谢糜應应齋斋濮濯賽赛蹇謇禮礼彌弥縱纵繆缪騎骑聶聂藤藩豐丰叢丛瞿闕阙曠旷顓颛簡简雙双邊边歸归鎮镇鎖锁謬谬顔颜額额禰祢藺蔺蘇苏麴闞阚關关蟻蚁嚴严羅罗鏡镜譚谭譙谯龐庞類类瀧泷懷怀繩绳壤蘭兰酆鹹咸黨党籍鐘钟釋释饒饶騰腾寶宝竇窦權权酈郦鐵铁鐸铎夔顧顾續续穰龔龚襲袭欒栾讓让蠻蛮釁衅鬱郁abcdefghijklmnopqrstuvwxyz";


const ENTRY = {
    "article": "any article published in a periodical like a journal article or magazine article",
    "book": "a book",
    "booklet": "like a book but without a designated publisher",
    "conference": "a conference paper",
    "inbook": "a section or chapter in a book",
    "incollection": "an article in a collection",
    "inproceedings": "a conference paper (same as the conference entry type)",
    "manual": "a technical manual",
    "misc": "used if nothing else fits",
    "phdthesis": "a PhD thesis",
    "mastersthesis": "a Masters thesis",
    "proceedings": "the whole conference proceedings",
    "techreport": "a technical report, government report or white paper",
    "unpublished": "a work that has not yet been officially published",
}

const FIELDS = {
    "title": "论文名称",
    "author": "作者名单",
    "journal": "文章发表的期刊或杂志名称",
    "booktitle": "书名，论文集的名称或会议名称",
    "month": "作品出版的月份",
    "year": "出版的年份",
    "volume": "卷号",
    "doi": "",
    "number": "报告号或期刊文章的刊号",
    "pages": "文章所在书籍或论文集中的页码或页范围",
    "address": "出版商地址或会议举办的地址",
    "organization": "组织或赞助会议或出版手册的机构名称，如 IEEE/ACM/Springer",
    "annote": "注释",
    "chapter": "书中的章节编号",
    "edition": "书的版本号",
    "editor": "书或者论文集的编辑名单",
    "howpublished": "特别出版物的出版通知",
    "institution": "发表及/或赞助报告的机构名称",
    "note": "关于参考文献的说明",
    "publisher": "出版社",
    "school": "大学或学位授予机构名称",
    "series": "name of the series or set of books",
    "type": "技术报告或论文的类型",
    "url": "网址",
    'isbn': 'ISBN',
    'issn': 'ISSN',
    "date": "日期",//优先级高于year
}

const BIB = {
    'article': {
        'N': ['author', 'year', 'title', 'journal'],
        'UN': ['volume', 'number', 'pages', 'month', 'doi', 'note'],
        'UQ': []
    },
    'conference': {
        'N': ['author', 'year', 'title', 'booktitle'],
        'UN': ['editor', 'volume', 'number', 'series', 'pages', 'address', 'month', 'organization', 'publisher', 'note'],
        'UQ': ['volume/number']
    },
    'inproceedings': {
        'N': ['author', 'year', 'title', 'booktitle'],
        'UN': ['editor', 'volume', 'number', 'series', 'pages', 'address', 'month', 'organization', 'publisher', 'note'],
        'UQ': ['volume/number']
    },
    'proceedings': {
        'N': ['title', 'year', 'editor'],
        'UN': ['volume', 'number', 'series', 'address', 'month', 'organization', 'publisher', 'note'],
        'UQ': ['volume/number']
    },
    'book': {
        'N': ['author', 'title', 'publisher', 'year'],
        'UN': ['volume', 'number', 'series', 'address', 'edition', 'month', 'note'],
        'UQ': ['volume/number']
    },
    'booklet': {
        'N': ['title'],
        'UN': ['author', 'howpublished', 'address', 'month', 'year', 'note'],
        'UQ': []
    },
    'inbook': {
        'N': ['author', 'title', 'chapter', 'pages', 'publisher', 'year'], 'UN': ['volume', 'number', 'series', 'type', 'address', 'edition', 'month', 'note'],
        'UQ': ['volume/number', 'chapter/pages']
    },
    'incollection': {
        'N': ['author', 'title', 'booktitle', 'publisher', 'year'],
        'UN': ['editor', 'volume', 'number', 'series', 'type', 'chapter', 'pages', 'address', 'edition', 'month', 'note'],
        'UQ': ['volume/number']
    },
    'mastersthesis': {
        'N': ['author', 'title', 'school', 'year'],
        'UN': ['type', 'address', 'month', 'note'],
        'UQ': []
    },
    'phdthesis': {
        'N': ['author', 'title', 'year', 'school'],
        'UN': ['address', 'month', 'keywords', 'note'],
        'UQ': []
    },
    'manual': {
        'N': ['title'], 'UN': ['author', 'organization', 'address', 'edition', 'month', 'year', 'note'],
        'UQ': []
    },
    'techreport': {
        'N': ['author', 'title', 'institution', 'year'],
        'UN': ['type', 'number', 'address', 'month', 'note'],
        'UQ': []
    },
    'unpublished': {
        'N': ['author', 'title', 'note'],
        'UN': ['month', 'year'],
        'UQ': []
    },
    'misc': {
        'N': [],
        'UN': ['author', 'title', 'howpublished', 'month', 'year', 'note'],
        'UQ': []
    }
}

class itex {
    constructor(text) {
        this.orgT = text;
        this.T = text.trim();


    };

    get language() {
        if (!this.hasOwnProperty("_language")) {
            this._language = ''
            if (/^[\u4e00-\u9fa5]/.test(this.T)) {
                this._language = 'zh';
            } else {
                this._language = 'en';
            }
        }
        return this._language
    }

    set language(v) {
        this._language = v;

    }

    get T() {
        return this._T;
    }

    set T(text) {
        if (!this.hasOwnProperty("_T")) {
            this._T = ""
        }
        if (!this.hasOwnProperty("_listT")) {
            this._listT = ['']
        }

        let i = this._listT.indexOf(this._T);
        if (i > -1) {
            this._listT[i] = text;
        }
        this._T = text;
    }


    _insert(f, b, T = this.T, _listT = this._listT) {
        //遍历 [a,1,] 数组,打印 数组元素的值和下标
        for (let k of f) {
            let i = _listT.indexOf(T);
            if (_listT.indexOf(k) > -1) {
                continue;
            }
            _listT.splice(i, 0, k);
        }
        for (let k of b) {
            let i = _listT.indexOf(T);
            if (_listT.indexOf(k) > -1) {
                continue;
            }
            _listT.splice(i + 1, 0, k);
        }
        return _listT;
    }

    /**
     * 获取最终输出的文本
     */
    get macro() {
        this.T = ` ${this.T}`
        return this._listT.join("");
    }

    get str() {
        return this.T;
    }


    get Title() {
        const commonWords = ["a", "an", "and", "but", "or", "for", "nor", "on", "in", "at", "to", "from", "by", "with", "about", "above", "across", "after", "against", "along", "among", "around", "before", "behind", "below", "beneath", "beside", "between", "beyond", "during", "except", "inside", "into", "like", "near", "of", "off", "out", "over", "past", "since", "through", "throughout", "till", "toward", "under", "until", "up", "upon", "via", "without"];

        let _listT = this._listT;
        let T = this.T;
        let k = _listT.indexOf(T)
        if (k > -1) {
            let i = _listT[k];
            i = i.toLowerCase();
            //将i 按照空格进行分割,如果元素不在 commonwords 数组中,则不进行首字母大写替换
            i = i.replace(/\b(\w+)\b/g, function (m, p1) {
                if (commonWords.indexOf(p1) > -1) {
                    return p1;
                } else {
                    return p1.replace(/(^\s*)(\w)/, function (m, p1, p2) {
                        return p1 + p2.toUpperCase();
                    });
                }
            });
            // update value
            this.T = i;
            this._listT[k] = i;

        }
        return this;
    }


    /**
     * 首字母大写   
     */
    get title() {
        let _listT = this._listT;
        let T = this.T;

        let k = _listT.indexOf(T)
        if (k > -1) {
            let i = _listT[k];
            i = i.toLowerCase();
            // 将i 的第一个单词的首字母进行大写替换 
            i = i.replace(/(^\s*)(\w)/, function (m, p1, p2) {
                return p1 + p2.toUpperCase();
            });
            // update value
            this.T = i;
            this._listT[k] = i;
        }
        return this;
    }

    // /**
    //  * 斜体
    //  */
    get italic() {
        this._listT = this._insert(["{", "\\em"], ["}"]);
        return this;
    }

    /**
     * 粗体
     */
    get bold() {
        this._listT = this._insert(["{", "\\bfseries"], ["}"]);
        return this;
    }

    /**
     * 圆括号
     */
    get cirBrackets() {
        let t = this.T;
        t = (this.language == 'zh') ? `（${t}）` : `(${t})`;
        this.T = t;
        return this;
    }

    /*
     * 方括号
     */
    get squBrackets() {
        let t = this.T;
        t = (this.language == 'zh') ? `〔${t}〕` : `[${t}]`;
        this.T = t;
        return this;
    }

    get clear() {
        let CharList = ['.', '。', '，', ',', '、', '；', ';', '：', ':', '？', '?', '！', '!', '）', ')', '】', ']', '}', '>', '”', '"', '’', "'"];

        let t = this.T;
        // 循环判断 变量 t 的最后一个字符是否在 CharList 中
        while (CharList.indexOf(t.slice(-1)) > -1) {
            t = t.slice(0, -1);
        }
        //如果变量t中 存在非 \& 的 & 符号,则将其替换为 \&
        t = t.replace(/(?<!\\)&/g, '\\&');
        t = t.replace(/(?<!\\)%/g, '\\%');
        t = t.replace(/(?<!\\)_/g, '\\_');
        this.T = t;
        return this;

    }

    get url() {
        let t = this.T;
        // 使用 正则表达式 在t 中匹配https开头,连续的字符串,空格或换行 结束的字符串 

        let url = t.split(" ")
        //如果url 元素包含http或https,则将其替换为 \url{网址}
        url = url.map((v) => {
            if (v.indexOf('http://') > -1 || v.indexOf('https://') > -1) {
                return `\\url{${v}}`;
            } else {
                return v;
            }
        })
        // 将url 数组转换为字符串
        t = url.join(" ");
        this.T = t;
        return this;
    }


}

class idate extends itex {
    constructor(text) {
        super(text);
        this.month_dict = {
            "1": 'January',
            "1": 'February',
            "3": 'March',
            "4": 'April',
            "5": 'May',
            "6": 'June',
            "7": 'July',
            "8": 'August',
            "9": 'September',
            "10": 'October',
            "11": 'November',
            "12": 'December'
        };

        // 创建月份英文单词的简写字典
        this.month_dict_abbr = {};
        for (let k in this.month_dict) {
            let v = this.month_dict[k];
            this.month_dict_abbr[k] = v.slice(0, 3);
            if (k == 9) {
                this.month_dict_abbr[k] = v.slice(0, 4);
            }
        };
    }

    get date() {
        let t = this.orgT.trim();
        //检测t是否包含英文字母
        if (/[a-zA-Z]/.test(t)) {
            var r1 = /(?<month>\w*)\D*(?<day>\d{0,2})\D*(?<endday>\d{0,2})\D+(?<year>[1,2]?\d{3})/;
            var r2 = /(?<year>[1,2]\d{3})\D+?(?<month>\w*)\D*(?<day>\d{0,2})\D*(?<endday>\d{0,2})/;
        }
        else {
            var r1 = /(?<year>[1,2]\d{3})\D*(?<month>\d{0,2})\D*(?<day>\d{0,2})\D*(?<endday>\d{0,2})/;
            var r2 = /(?<month>\d{0,2})\D*(?<day>\d{0,2})\D*(?<endday>\d{0,2})\D+?(?<year>[1,2]\d{3})/;
        }
        for (let r of [r1, r2]) {
            if (r.test(t)) {
                let a = r.exec(t);
                if (a != null) {
                    var { year, month, day, endday } = a.groups;
                }
            }
        }
        if (year == undefined) {
            year = ''
        }
        this._year = year;
        if (month == undefined) {
            month = ''
        }
        this._month = month;
        if (day == undefined) {
            day = ''
        }
        this._day = day;
        if (endday == undefined) {
            endday = ''
        }
        this._endday = endday;
        // console.log(year, month, day, endday);
        //如果 month 是数字,且长度为1,则在前面补0
        if (/[a-zA-Z]/.test(month)) {
            for (let k in this.month_dict) {
                let m = month.toLowerCase()
                let tm = this.month_dict[k].toLowerCase();
                // 如果  may 字符 出现在this.month_dict[k]中,不区分大小写
                if (tm.indexOf(m) > -1) {
                    this._month = k;
                    break;
                }
            }
        }
        // this._month 长度为2 且第一个字符为0
        if (this._month.length == 2 && this._month[0] == 0) {
            this._month = this._month[1];
        }
        // 如果 this._month 转为数字类型
        if (Number(this._month) > 12) {
            this._month = "";
        }
        if (day > 31) {
            this._day = "";
        }
        if (endday > 31) {
            this._endday = "";
        }
        t = [this._year, this._month, this._day, this._endday];
        // 去空元素
        t = t.filter((i) => i != "");
        t = t.join("-");
        this.T = t;
        return this;
    }

    get year() {
        if (!this.hasOwnProperty('_year')) {
            this.date;
        }
        this.T = this._year;
        return this
    }

    get month() {
        if (!this.hasOwnProperty('_year')) {
            this.date;
        }
        this.T = this._month;
        return this

    }

    get month_en_abbr() {
        if (!this.hasOwnProperty('_month')) {
            this.date;
        }
        let mon = this._month;
        mon = this.month_dict_abbr[mon];
        this.T = mon;
        return this;
    }

    get month_en_full() {
        if (!this.hasOwnProperty('_month')) {
            this.date;
        }
        let mon = this._month;
        mon = this.month_dict[mon];
        this.T = mon;
        return this;
    }

    get day() {
        this.date;
        this.T = this._day;
        return this
    }

    get endday() {
        this.date;
        this.T = this._endday;
        return this
    }

    get date_zh() {
        if (!this.hasOwnProperty('_year')) {
            this.date;
        }
        if (this._year != "") {
            var y = this._year + "年"
        };
        if (this._month != "") {
            var m = this._month + "月"
        };
        if (this._endday != "") {
            var d = this._day
            var ed = this._endday + "日"
            d = d + "~" + ed
        } else if (this._day != "") {
            var d = this._day + "日"
        };
        this.T = [y, m, d].join("");
        return this;
    }

    get date_en_abbr() {
        if (!this.hasOwnProperty('_year')) {
            this.date;
        }
        let [y, m, d] = ['', '', '', ''];
        if (this._year != "") {
            y = this._year + ","
        };
        if (this._month != "") {
            m = this.month_en_abbr.str + "."
        };
        if (this._endday != "") {
            d = this._day + "-" + this._endday
        } else if (this._day != "") {
            d = this._day
        };
        let t = [y, m, d];
        //  [y, m, d + "-" + ed]去空格 去空元素
        this.T = t.filter((i) => i != "").join(" ");
        return this;
    }

    get date_en_full() {
        if (!this.hasOwnProperty('_year')) {
            this.date;
        }
        if (this._year != "") {
            var y = this._year + ","
        };
        if (this._month != "") {
            var m = this.month.month_en_full.str
        };
        if (this._endday != "") {
            var d = this._day
            var ed = this._endday
            d = d + "-" + ed
        } else if (this._day != "") {
            var d = this._day
        };
        let t = [y, m, d];
        //  [y, m, d + "-" + ed]去空格 去空元素
        this.T = t.filter((i) => i != "").join(" ");

        return this;
    }

    get apa_year() {
        if (!this.hasOwnProperty('_year')) {
            this.date;
        }
        return this._year;
    }
}

class iname extends itex {
    constructor(text) {
        super(text);
    }

    get language() {
        if (this.hasOwnProperty("_language")) { return this["_language"]; }

        this._language = ''
        let t = this.T;
        t = t.match(/[\u4e00-\u9fa5]/) ? 'zh' : 'en';
        this["_language"] = t;
        return this["_language"];
    }

    set language(lang) {
        this["_language"] = lang;
    }

    get name() {
        if (this.hasOwnProperty("_name")) { return this["_name"] };
        this._name = 'author'
        return this._name;
    }

    set name(v) {
        this._name = v;
    }

    __to_list() {
        let t_list = this.T;
        let name = this.name;
        let fidld1 = `_${name}_list`
        let fidld2 = `_${name}_num`

        t_list = t_list.split('and').map(x => x.trim()).filter(x => x !== '');
        this[fidld1] = t_list;
        this[fidld2] = t_list.length;
    }

    __cn_name_dict() {
        let name = this.name;
        this.__to_list();

        let t_list = this[`_${name}_list`]
        let t_dic = {};
        t_list.forEach((n, index) => {
            // 如果,符号   在作者名字中
            if (n.includes(",")) {
                //,符号分割 ,去空格去除空元素
                n = n.split(",").map(s => s.trim()).filter(s => s);
                // 将第一个元素保存到 namedict[index]['first'] 中
                t_dic[index] = { 'first': [n[0]] };
                // 删除第一个元素
                n.shift();
                // 将剩余元素保存到 namedict[index]['others'] 中
                t_dic[index]['others'] = n;

            } else {
                n = n.trim().replace(" ", '');
                if (n.length >= 4) {
                    //将前两个字符保存到 namedict[index]['first'] 中
                    t_dic[index] = { 'first': [n.slice(0, 2)] };
                    //将剩余字符保存到 namedict[index]['others'] 中
                    t_dic[index]['others'] = [n.slice(2)];
                } else {
                    //将字符保存到 namedict[index]['first'] 中
                    t_dic[index] = { 'first': [n.slice(0, 1)] };
                    //将剩余字符保存到 namedict[index]['others'] 中
                    t_dic[index]['others'] = [n.slice(1)];
                }
            }
        });
        t_dic = Object.fromEntries(Object.entries(t_dic).sort());
        return t_dic;
    }

    __en_name_dict() {
        let name = this.name;
        this.__to_list();
        let t_list = this[`_${name}_list`]
        let t_dic = {};
        t_list.forEach((n, index) => {
            // 如果,符号   在作者名字中
            if (n.includes(",")) {
                // ,分割 author去空格,去除空元素
                n = n.split(",").map(s => s.trim()).filter(s => s !== "");
                // 将第一个元素保存到 namedict[index]['first'] 中
                t_dic[index] = { 'first': [n[0]] };
                // 删除第一个元素
                n.shift();
            } else {
                // 被空格分割
                n = n.split(" ").map(s => s.trim()).filter(s => s !== "");
                // 将最一个元素保存到 namedict[index]['first'] 中
                t_dic[index] = { 'first': [n[n.length - 1]] };
                // 删除最后一个元素
                n.pop();
            }
            n = n.join(" ");
            n = n.split(" ").map(s => s.trim()).filter(s => s).map(s => s.replace(".", ""));
            t_dic[index]['others'] = n;

        });
        // 更新 t_dic,按key 排序
        t_dic = Object.fromEntries(Object.entries(t_dic).sort());
        return t_dic;
    }

    __to_dict() {
        let name = this.name;
        let field = `_${name}_dict`;
        if (!this.hasOwnProperty(field)) {
            let lan = this.language;
            let v = ''
            if (lan == 'zh') {
                v = this.__cn_name_dict()
            } else if (lan == 'en') {
                v = this.__en_name_dict()
            }
            this[field] = v;
        }
        // return this[field];
    }

    _join_name(t_dic, k) {
        let [a, b] = ['', ''];
        a = t_dic[k]['first'].map(s => s.charAt(0).toUpperCase() + s.slice(1))
        a = a.filter(s => s !== "")
        a = a.join(" ");
        b = t_dic[k]['others'].map(s => s.charAt(0).toUpperCase())
        b = b.filter(s => s !== "")
        b = b.join(".");
        a = [a, b].join("");
        return a;

    }

    get apa_authors() {
        this.name = 'author';
        let name = this.name;
        let apaField = `_${name}_apa7`
        if (this.hasOwnProperty(apaField)) { return this[apaField] };
        this.__to_dict();
        let t_dic = this[`_${name}_dict`];
        let lan = this.language;
        let num_name = this[`_${name}_num`]

        let v = "";
        let a = "";
        let apa_sty_name = [];

        if (lan == 'en') {
            for (let key in t_dic) {
                if (key == 0) {
                    a = this._join_name(t_dic, key)
                    apa_sty_name.push(a);
                };
                if (key >= 1 && key <= 19 && key < num_name - 1) {
                    a = this._join_name(t_dic, key)
                    apa_sty_name.push(a);
                };
                if (key != 0 && key == num_name - 1) {
                    a = this._join_name(t_dic, key)
                    apa_sty_name.push(`\\& ${a}`);
                };
                if (key == 20 && num_name >= 21) {
                    apa_sty_name.push(`,...`);
                };
            }
            v = apa_sty_name.join(", ");
        } else if (lan == 'zh') {
            for (let key in t_dic) {
                if (key == 0) {
                    a = t_dic[0]['first'].join("");
                    a += t_dic[0]['others'].join("");
                    apa_sty_name.push(a);
                };
                if (key >= 1 && key <= 19 && key < num_name - 1) {
                    //当key 大于20时
                    a = t_dic[key]['first'].join("");
                    a += t_dic[key]['others'].join("");
                    apa_sty_name.push(a);
                };
                if (key != 0 && key == num_name - 1) {
                    a = t_dic[num_name - 1]['first'].join("");
                    a += t_dic[num_name - 1]['others'].join("");
                    apa_sty_name.push(a);
                };
                if (key == 20 && num_name >= 21) {
                    apa_sty_name.push(`、……`);
                };
            };
            v = apa_sty_name.join("、");
        }
        this[apaField] = v;
        return this[apaField]
    }

    get apa_editors() {
        this.name = 'editor';
        let name = this.name;
        let apaField = `_${name}_apa7`
        if (this.hasOwnProperty(apaField)) { return this[apaField] };
        this.__to_dict();
        let t_dic = this[`_${name}_dict`];
        let lan = this.language;
        let a = "";

        if (lan == 'en') {
            a = this._join_name(t_dic, 0)
            a = `In ${a} (Ed.)`;
        } else if (lan == 'zh') {
            a = t_dic[0]['first'].join("");
            a += t_dic[0]['others'].join("");
            a = `在${a}（主编）`;
        }
        this[apaField] = a;
        return this[apaField]
    }

    get apa_chair() {
        this.name = 'chairs';
        let name = this.name;
        let apaField = `_${name}_apa7`
        if (this.hasOwnProperty(apaField)) { return this[apaField] };
        this.__to_dict();
        let t_dic = this[`_${name}_dict`];
        let lan = this.language;
        let a = "";

        if (lan == 'en') {
            a = this._join_name(t_dic, 0)
            a = `In ${a}(Ch.)`;
        } else if (lan == 'zh') {
            a = t_dic[0]['first'].join("");
            a += t_dic[0]['others'].join("");
            a = `在${a}（主持）`;
        }
        this[apaField] = a;
        return this[apaField]
    }

    get apa_citeauthor() {
        this.name = 'author';
        let name = this.name;
        let apaField = `_${name}_apa7`
        if (this.hasOwnProperty(apaField)) { return this[apaField] };
        this.__to_dict();
        let t_dic = this[`_${name}_dict`];
        let lan = this.language;
        let num_name = this[`_${name}_num`]

        let t = "";

        if (lan == 'en') {
            t += t_dic[0]['first'].map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(" ");
            if (num_name == 2) {
                t += ' \\& ';
                t += t_dic[1]['first'].map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(" ");
            } else if (num_name >= 3) {
                t += ' et al.';
            }
        } else if (lan == 'zh') {
            t += t_dic[0]['first'].join("");
            t += t_dic[0]['others'].join("");
            if (num_name == 2) {
                t += '與';
                t += t_dic[1]['first'].join("");
                t += t_dic[1]['others'].join("");
            } else if (num_name >= 3) {
                t += `等`;
            }
        }
        this[apaField] = t;
        return this[apaField]
    }
}

class anybib {
    constructor(txt) {
        /**
         * 原始输入的单个 bib 文本
         */
        this.txt = txt;

        /**
         * 去空行和注释后的原始单个 bib 文本
         */
        this.f_txt = txt.split('\n').filter(line => line.trim() !== '' && !line.trim().startsWith('%')).join('\n');
        txt = this.f_txt;
        let entry = this.entryType;
        //如果 entry 不在 ENTRY的key中
        if (!Object.keys(ENTRY).includes(entry)) {
            return ""
        }

        let fileds = BIB[entry]['N'] + BIB[entry]['UN'];

        //遍历 BIB[entry]['N'] 所有的字段，并创建
        BIB[entry]['N'].forEach(f => {
            this[`org_${f}`] = '';
        });

        const key_value = [...txt.matchAll(/(\w+)\s*=\s*["{](.*)["}]/g)].map(m => [m[1], m[2]]);
        key_value.forEach(([field, value]) => {
            field = field.toLowerCase().trim();
            value = value.trim();
            if (fileds.includes(field) && value != '') {
                // 如果field 在 数组[note,authout]中则不需要处理
                if (['note', 'url',].includes(field)) {
                    value = new itex(value);
                    value = value.url.str
                    this[`org_${field}`] = value;
                } else {
                    value = new itex(value);
                    value = value.clear.str;
                    this[`org_${field}`] = value;
                }
            }
        });

    }

    get_field(field, a = 'apa7', o = 'org') {
        let apaField = `${a}_${field}`;
        let orgField = `${o}_${field}`;

        if (!Object.keys(this).includes(orgField)) { this[orgField] = ''; }
        if (!Object.keys(this).includes(apaField)) { this[apaField] = ''; }

        return [apaField, orgField];
    }

    get entryType() {
        let [apaField, _] = this.get_field('entryType', 'apa7', '');
        if (this[apaField] != '') { return this[apaField] };

        let t = this.f_txt;
        t = t.match(/@(\w*\s*){/)[1];
        t = t.toLowerCase().trim();
        this[apaField] = t;
        return this[apaField];
    }

    get citekey() {
        let [apaField, _] = this.get_field('citekey', 'apa7', '');
        if (this[apaField] != '') { return this[apaField] };

        let t = this.f_txt;
        t = t.match(/@\w+\s*[{]\s*(\w+)\s*,/)[1];
        t = t.toLowerCase().trim();
        this[apaField] = t;
        return this[apaField];
    }

    get author() {
        let [_, orgField] = this.get_field('author');

        return this[orgField];
    }

    get apa_authors() {
        let author = this.author;
        if (author == '') { return "" }
        author = new iname(author);
        return author.apa_authors;
    }

    get apa_citetxt() {
        let [apaField, _] = this.get_field('citetxt', 'apa7', '');
        if (this[apaField] != '') { return this[apaField] };

        let citeauthor = this.author;
        if (citeauthor == '') {
            citeauthor = "null"
        } else {
            citeauthor = new iname(citeauthor);
            citeauthor = citeauthor.apa_citeauthor;
        }
        let year = this.year;
        year = new idate(year);
        year = year.year.str
        if (year == '') { year = this.year }
        let value = [citeauthor, year].join(', ')
        this[apaField] = value;
        return this[apaField];
    }

    set apa_citetxt(v) {
        let [apaField, _] = this.get_field('citetxt', 'apa7', '');
        let vaule = this.apa_citetxt;
        let apayear = vaule.match(/\d{4}/g)[0]
        vaule = vaule.replace(apayear, `${apayear}${v}`)
        this[apaField] = vaule;
    }

    get language() {

        let [apaField, _] = this.get_field('language', 'apa7', '');
        if (this[apaField] != '') { return this[apaField] };
        let t = "";
        if (this.hasOwnProperty("org_author")) {
            t = this.author[0];
        }
        if (t == undefined && this.hasOwnProperty("org_editor")) {
            t = this.editor[0];
        }
        if (t == undefined && this.hasOwnProperty("org_title")) {
            t = this.title[0];
        }
        t = t.match(/[\u4e00-\u9fa5]/) ? 'zh' : 'en';

        this[apaField] = t;
        return this[apaField];
    }

    get apa_title() {
        let [apaField, orgField] = this.get_field('title');
        let title = this[orgField];
        if (this[orgField] == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        let language = this.language;
        let entryType = this.entryType;
        let typelist = ['article', 'conference', 'incollection'];

        let value = new itex(title);
        if (language == 'zh') {
            // 如果this.entryType 出现在 lista ['book] 中
            if (!typelist.includes(entryType)) {
                value = value.clear.bold.macro

            } else {
                value = value.clear.str;
            }
        } else if (language == 'en') {
            if (!typelist.includes(entryType)) {
                value = value.clear.title.italic.macro;
            } else {
                value = value.clear.title.str;
            }
        }
        this[apaField] = value;
        return this[apaField]
    }

    get apa_booktitle() {//"书名，论文集的名称或会议名称", 会议论文
        let [apaField, orgField] = this.get_field('booktitle');
        let booktitle = this[orgField];
        if (booktitle == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        let language = this.language;
        let entryType = this.entryType;
        let typelist = ['article', 'incollection', 'conference'];
        let value = new itex(booktitle);
        if (language == 'zh') {
            // 如果this.entryType 出现在 lista ['book] 中
            if (typelist.includes(entryType)) {
                value = value.bold.macro
            } else {
                value = value.title.str;
            }
        } else if (language == 'en') {
            if (typelist.includes(entryType)) {
                value = value.title.italic.macro;
            } else {
                value = value.title.str;
            }
        }
        this[apaField] = value;
        return this[apaField]
    }

    get apa_series() {
        let [apaField, orgField] = this.get_field('series');
        let series = this[orgField];
        if (series == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        let language = this.language;
        let entryType = this.entryType;
        let typelist = ['book', 'inbook'];
        let value = new itex(series);
        if (language == 'zh') {
            // 如果this.entryType 出现在 lista ['book] 中
            if (typelist.includes(entryType)) {
                value = value.bold.macro
                if (this.apa_volume != '') {
                    value += this.org_volume + "卷";
                }

            } else {
                value = value.title.str;
            }
        } else if (language == 'en') {
            if (typelist.includes(entryType)) {
                value = value.title.italic.macro;
                if (this.apa_volume != '') {
                    value = "volume " + this.org_volume + " of " + value;
                }
            } else {
                value = value.title.str;
            }
        }

        this[apaField] = value;
        return this[apaField];
    }

    get apa_chapter() {//章节编号或标题
        let [apaField, orgField] = this.get_field('chapter');
        let chapter = this[orgField];
        if (chapter == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        let language = this.language;
        let entryType = this.entryType;
        let typelist = ['book', 'inbook'];
        let value = new itex(chapter);
        if (language == 'zh') {
            // 如果this.entryType 出现在 lista ['book] 中
            if (typelist.includes(entryType)) {
                value = value.title.str
                value += "章";

            } else {
                value = value.title.str;
            }
        } else if (language == 'en') {
            if (typelist.includes(entryType)) {
                value = "chapter " + value.title.str;
            }
        }

        this[apaField] = value;
        return this[apaField];
    }

    get apa_date() {
        let [_, orgField] = this.get_field('date');
        let date = this[orgField];
        if (this[orgField] != '') { return this[orgField] };

        this[orgField] = date;
        return this[orgField]
    }

    get year() {
        let [apaField, orgField] = this.get_field('year');

        let year = this[orgField];
        if (this[orgField] != '') {
            //如果没有在year中匹配到4个数字
            if (year.match(/\d{4}/) && year.length == 4) {
                year = new idate(year);
                year = year.year.str;
                this[orgField] = year;
                return this[orgField];
            }
        };

        let language = this.language;
        let value = ''
        // 如果year 和 date 都为空，返回（出版中）
        // 如果year 为空，返回 date
        year = new idate(year);
        value = year.str;
        if (value == '') {
            if (language == 'zh') {
                value = `出版中`

            } else if (language == 'en') {
                value = "in press"
            }
        };
        this[orgField] = value
        return this[orgField];
    }

    get apa_year() {
        let [apaField, _] = this.get_field('apayear');
        if (this[apaField] != '') { return this[apaField] };

        let year = this.year;
        let language = this.language;
        let entryType = this.entryType;

        if (!year.match(/\d{4}/)) {
            if (language == 'zh') {
                return `（出版中）`
            } else if (language == 'en') {
                return "(in press)"
            }
        };
        // 如果year 为空，返回 date
        // if (this[apaField] != '') { return this[apaField] };

        let value = new idate(year);
        value.language = language;
        if (language == 'zh') {
            switch (entryType) {
                case 'misc':
                    value = value.date_zh.cirBrackets.str;
                    break;
                case 'conference':
                    value = value.date_zh.cirBrackets.str;
                    break;
                default:
                    value = value.year.cirBrackets.str;
                    break;
            }
        } else if (language == 'en') {
            switch (entryType) {
                case 'misc':
                    value = value.date_zh.cirBrackets.str;
                    break;
                case 'conference':
                    value = value.date_zh.cirBrackets.str;
                    break;
                default:
                    value = value.year.cirBrackets.str;
                    break;
            }
        }
        this[apaField] = value;
        return this[apaField]
    }

    set apa_year(v) {
        let [apaField, _] = this.get_field('apayear');
        // console.log(this.apa_year,'eeeeeeeeeee')
        let vaule = this.apa_year;
        let apayear = vaule.match(/\d{4}/g)[0]
        vaule = vaule.replace(apayear, `${apayear}${v}`)
        this[apaField] = vaule;
    }

    get apa_journal() {
        let [apaField, orgField] = this.get_field('journal');
        let journal = this[orgField];
        if (journal == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        let language = this.language;
        let entryType = this.entryType;

        let value = new itex(journal);
        value.language = language;
        if (language == 'zh') {
            switch (entryType) {
                default:
                    value = value.title.bold.macro;
                    break;
            }
        } else if (language == 'en') {
            switch (entryType) {
                default:
                    value = value.Title.italic.macro;
                    break;
            }
        }
        this[apaField] = value;
        return this[apaField]
    }

    get apa_volume() {
        let [apaField, orgField] = this.get_field('volume');
        let volume = this[orgField];
        if (volume == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };


        let language = this.language;
        let entryType = this.entryType;


        let value = new itex(volume);
        value.language = language;

        if (language == 'zh') {
            switch (entryType) {
                default:
                    value = value.italic.bold.macro
                    break;
            }
        } else if (language == 'en') {
            switch (entryType) {
                default:
                    value = value.italic.macro
                    break;
            }
        }
        this[apaField] = value;
        return this[apaField]
    }

    get apa_number() {
        let [apaField, orgField] = this.get_field('number');
        let number = this[orgField];
        if (number == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        let language = this.language;
        let entryType = this.entryType;


        let value = new itex(number);
        value.language = language;

        if (language == 'zh') {
            switch (entryType) {
                default:
                    value = value.cirBrackets.str
                    break;
            }
        } else if (language == 'en') {
            switch (entryType) {
                default:
                    value = value.cirBrackets.str
                    break;
            }
        }
        this[apaField] = value;
        return this[apaField]
    }

    get apa_pages() { //页码
        let [apaField, orgField] = this.get_field('pages');
        let pages = this[orgField];
        if (pages == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        let language = this.language;
        let entryType = this.entryType;

        let typelist = ['book', 'inbook', 'incollection', 'conference'];
        let value = new itex(pages);

        //  如果pages 包含英文文,则不进行处理\
        if (pages.match(/[\u4e00-\u9fa5]/g) != null || pages.match(/[\u4e00-\u9fa5]/g) != null) {
            // if (pages.match(/[\u4e00-\u9fa5]/g) != null) { 

            // if (pages.match(/\d+/g) == null) {
            value.language = language;
            value = value.squBrackets.str;
        } else {
            if (language == 'zh') {
                // 如果this.entryType 出现在 lista ['book] 中
                if (typelist.includes(entryType)) {
                    value = `（頁 ${value.str}）`
                } else {
                    value = value.str;
                }
            } else if (language == 'en') {
                if (typelist.includes(entryType)) {
                    value = ` (pp.${value.str})`;
                } else {
                    value = value.str;
                }
            }

        }
        this[apaField] = value;
        return this[apaField]
    }

    get apa_doi() {//学术文献 DOI 
        let [apaField, orgField] = this.get_field('doi');
        let doi = this[orgField];
        if (doi == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        // 判断 "https://doi.org/" 是否存在 attr 字符中
        if (!doi.includes("https://")) { doi = `https://doi.org/${doi}`; }
        let value = `\\url{${doi}}`;
        this[apaField] = value;
        return this[apaField]
    }

    get apa_publisher() {//出版社
        let [apaField, orgField] = this.get_field('publisher');
        let publisher = this[orgField];
        if (publisher == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        let language = this.language;
        let entryType = this.entryType;

        publisher = new itex(publisher);

        if (language == 'zh') {
            switch (entryType) {
                default:
                    publisher = publisher.clear.bold.str;
                    break;
            }
        } else if (language == 'en') {
            switch (entryType) {
                default:
                    publisher = publisher.clear.Title.italic.str;
                    break;
            }
        }

        this[apaField] = publisher;
        return this[apaField];
    }

    get apa_address() { // 地址
        let [apaField, orgField] = this.get_field('address');
        let address = this[orgField];
        if (address == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        this[apaField] = address;
        return this[apaField];
    }

    get editor() {
        let [_, orgField] = this.get_field('editor');
        return this[orgField];
    }

    get apa_editors() {
        let editor = this.editor;
        if (editor == '') { return "" }
        editor = new iname(editor);
        return editor.apa_editors;
    }

    get apa_chair() {
        let chair = this.editor;
        if (chair == '') { return "null" }
        chair = new iname(chair);
        return chair.apa_chair;
    }

    get apa_edition() {
        let [apaField, orgField] = this.get_field('edition');
        let edition = this[orgField];
        if (edition == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        let language = this.language;
        let entryType = this.entryType;

        let value = new itex(edition);
        value.language = this.language;

        if (language == 'en') {
            switch (entryType) {
                case 'misc':
                    value = value.str;
                    break;
                default:
                    value = value.cirBrackets.str
                    break;
            }
        } else if (language == 'zh') {
            switch (entryType) {
                case 'misc':
                    value = value.str;
                    break;
                default:
                    value = value.cirBrackets.str
                    break;
            }
        }
        this[apaField] = value;
        return this[apaField];
    }

    get apa_howpublished() {
        let [apaField, orgField] = this.get_field('howpublished');
        let howpublished = this[orgField];
        if (howpublished == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        let language = this.language;
        let entryType = this.entryType;


        let value = new itex(howpublished);
        value.Language = this.language;

        if (language == 'zh') {
            switch (entryType) {
                default:
                    value = value.bold.str;
                    break;
            }
        } else if (language == 'en') {
            switch (entryType) {
                default:
                    value = value.Title.italic.str;
                    break;
            }
        }
        this[apaField] = value;
        return this[apaField];
    }

    get apa_institution() {
        let [apaField, orgField] = this.get_field('institution');
        let institution = this[orgField];
        if (institution == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        this[apaField] = institution;
        return this[apaField];

    }

    get apa_note() {
        let [apaField, orgField] = this.get_field('note');
        let note = this[orgField];
        if (note == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };
        note = new itex(note);
        note = note.url.str;
        this[apaField] = note;
        return this[apaField];
    }

    get apa_school() {
        let [apaField, orgField] = this.get_field('school');
        let school = this[orgField];
        if (school == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        this[apaField] = school;
        return this[apaField];
    }

    // organization
    get apa_organization() {
        let [apaField, orgField] = this.get_field('organization');
        let organization = this[orgField];
        if (organization == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };
        this[apaField] = organization;
        return this[apaField];
    }

    get apa_type() {// 会议报告类型
        let [apaField, orgField] = this.get_field('type');
        let type = this[orgField];
        if (type == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };
        let language = this.language;
        let entryType = this.entryType;

        let value = new itex(type);
        value.language = language;


        if (language == 'zh') {
            switch (entryType) {
                default:
                    value = value.squBrackets.str
                    break;
            }
        } else if (language == 'en') {
            switch (entryType) {
                default:
                    value = value.squBrackets.str
                    break;
            }
        }
        this[apaField] = value;
        return this[apaField];
    }

    get apa_url() {//普通 url
        let [apaField, orgField] = this.get_field('url');
        let url = this[orgField];
        if (url == '') { return '' };
        if (this[apaField] != '') { return this[apaField] };

        this[apaField] = `\\url{${url}}`;
        return this[apaField];

    }

    // ----------------- 以下为辅助函数 -----------------
    f_output(tlist, f = ', ') {
        var b = '.';
        var t = '';
        if (this.language == 'zh') {
            switch (f) {
                case ', ':
                    f = '，';
                    break;
                case '. ':
                    f = '。';
                    break;
                case ': ':
                    f = '：';
                    break;
                case '; ':
                    f = '；';
                    break;
                case ' ':
                    f = '';
                    break;
                default:
                    f = '';
                    break;
            }
            b = '。';
        }
        // lsit 去掉值为 '' 的元素\
        tlist = tlist.filter((item) => item != '');
        if (tlist.every((item) => item == '')) { return '' };
        //
        t += '\n\\newblock ';
        t += tlist.join(f);
        t += b;
        return t;

    }

    // ----------------- 以下为输出函数 -----------------
    /**
    @article
    期刊杂志论文
    必要域: author, title, journal, year.
    可选域: volume, number, pages, month, note.

    @article{
        % 以下为必选域
        author={},
        title={},
        journal={},
        year={},
        % 以下为可选域
        volume={},
        number={},
        pages={},
        note={}
    }
    */
    get article() {
        let info = `\\bibitem[${this.apa_citetxt}]{${this.citekey}}`;
        info += this.f_output([this.apa_authors, this.apa_year], ' ')
        info += this.f_output([this.apa_title]);
        info += this.f_output([this.apa_journal, this.apa_volume + this.apa_number, this.apa_pages], ', ')
        info += this.f_output([this.apa_note]);
        info += "\n";
        return info;
    }

    /**
    @book
    公开出版的图书
    必要域: author/editor, title, publisher, year.
    可选域: volume/number, series, address, edition, month, note.

    @book{
        % 以下为必选域
        author={},
        title={},
        publisher={},
        year={},
        % 以下为可选域
        volume={},
        series={},%书籍所属的系列名称或编号
        address={},
        edition={},
        month={},
        note={}
    }
    */
    get book() {// 出现在正文的引用文本+引用id,作者,年份,标题(出版版本),出版社, 
        let info = `\\bibitem[${this.apa_citetxt}]{${this.citekey}}`;
        info += this.f_output([this.apa_authors, this.apa_year], ' ')
        info += this.f_output([this.apa_title, this.apa_series], ', ');
        info += this.f_output([this.apa_address, this.apa_publisher], ': ');
        info += this.f_output([this.apa_note]);
        info += "\n";
        return info;
    }

    /**
    @booklet
    无出版商或作者的图书
    必要域: title.
    可选域: author, howpublished, address, month, year, note.
    */
    get booklet() {
        console.log("unsopoorted type: booklet")
    }

    /**
    @inbook
    书籍的一部分章节
    必要域: author/editor, title, chapter and/or pages, publisher, year.
    可选域: volume/number, series, address, edition, month, note.
    @inbook{
        % 以下为必选域
        author={},
        title={},
        publisher={},
        chapter={},% 或 pages={},
        year={},
        % 以下为可选域
        volume={},
        series={},%书籍所属的系列名称或编号
        address={},
        edition={},
        note={}
    }
    */
    get inbook() {
        let info = `\\bibitem[${this.apa_citetxt}]{${this.citekey}}`;

        info += this.f_output([this.apa_authors, this.apa_year], ' ')
        if (this.org_chapter != '') {
            info += this.f_output([this.apa_title + this.apa_edition, this.apa_chapter, this.apa_series], ', ');
        } else {
            info += this.f_output([this.apa_title + this.apa_edition, this.apa_series, this.apa_pages], ', ');
        }

        info += this.f_output([this.apa_address, this.apa_publisher]);
        info += this.f_output([this.apa_note]);
        info += "\n";
        return info;
    }

    /**
     * @incollection
    书籍中带独立标题的章节
    必要域: author, title, booktitle, publisher, year.
    可选域: editor, volume/number, series, chapter, pages, address, edition, month, note.
    @incollection{
        % 以下为必选域
        author={},
        title={},
        booktitle={},
        publisher={},
        year={},
        % 以下为可选域
        editor={},
        volume={},%或 number={},
        series={},%书籍所属的系列名称或编号
        chapter={},
        address={},
        edition={},
        note={}
    }
    */
    get incollection() {
        if (this.entryType != 'incollection') { return "" };

        let info = `\\bibitem[${this.apa_citetxt}]{${this.citekey}}`;
        info += this.f_output([this.apa_authors, this.apa_year], ' ')
        info += this.f_output([this.apa_title, this.apa_series], ', ');
        info += this.f_output([this.apa_editors, this.apa_booktitle + this.apa_edition + this.apa_pages], ', ');
        info += this.f_output([this.apa_address, this.apa_publisher], ', ');
        info += this.f_output([this.apa_note]);
        info += "\n";
        return info;
    }

    /**
     * @conference
   等价于 inproceedings
   必要域: author, title, booktitle, year.
   可选域: editor, volume/number, series, pages, address, month, organization, publisher, note.
     */
    get conference() {
        let info = `\\bibitem[${this.apa_citetxt}]{${this.citekey}}`;
        info += this.f_output([this.apa_authors, this.apa_year], ' ')
        info += this.f_output([this.apa_title]);
        info += this.f_output([this.apa_editors, this.apa_booktitle + this.apa_pages], ', ');
        info += this.f_output([this.apa_series, this.apa_address, this.apa_publisher,], ', ');
        info += this.f_output([this.apa_note]);
        info += "\n";
        return info;
    }

    get inproceedings() {
        return this.conference;
    }

    /**
    @proceedings
    会议论文集
    必要域: title, year.
    可选域: editor, volume/number, series, address, month, organization, publisher, note.
    */
    get proceedings() {
        console.log("unsopoorted type: proceedings")
    }

    /**
    @phdthesis
    必要域: author, title, year, school.
    可选域: address, month, keywords, note.
    */
    get phdthesis() {
        let info = `\\bibitem[${this.apa_citetxt}]{${this.citekey}}`;
        info += this.f_output([this.apa_authors, this.apa_year], ' ')
        info += this.f_output([this.apa_title]);
        info += this.f_output([this.apa_address, this.apa_school], ", ");
        info += this.f_output([this.apa_note]);
        info += "\n";
        return info;
    }

    get mastersthesis() {
        let info = `\\bibitem[${this.apa_citetxt}]{${this.citekey}}`;
        info += this.f_output([this.apa_authors, this.apa_year], ' ')
        info += this.f_output([this.apa_title]);
        info += this.f_output([this.apa_address, this.apa_school], ", ");
        info += this.f_output([this.apa_note]);
        info += "\n";
        return info;
    }

    /**
     * @manual
    技术文档
    必要域: title.
    可选域: author, organization, address, edition, month, year, note.
     */
    get manual() {
        console.log("unsopoorted type: manual")
    }

    /**
     * @techreport
    教育，商业机构的技术报告
    必要域: author, title, institution, year.
    可选域: type, number, address, month, note.
     */
    get techreport() {
        let info = `\\bibitem[${this.apa_citetxt}]{${this.citekey}}`;
        info += this.f_output([this.apa_authors, this.apa_year], ' ')
        info += this.f_output([this.apa_title + this.apa_type]);
        info += this.f_output([this.apa_institution]);
        info += this.f_output([this.apa_note]);
        info += "\n";
        return info;
    }

    /**
 *     @unpublished
    未出版的论文，图书
    必要域: author, title, note.
    可选域: month, year.
     */
    get unpublished() {
        let info = `\\bibitem[${this.apa_citetxt}]{${this.citekey}}`;
        info += this.f_output([this.apa_authors, this.apa_year], ' ')
        info += this.f_output([this.apa_title]);
        info += this.f_output([this.apa_note]);
        info += "\n";
        return info;
    }

    get misc() {
        let info = `\\bibitem[${this.apa_citetxt}]{${this.citekey}}`;
        info += this.f_output([this.apa_authors, this.apa_year], ' ')
        info += this.f_output([this.apa_title + this.apa_edition]);
        info += this.f_output([this.apa_journal, this.apa_howpublished, this.apa_volume, this.apa_number, this.apa_pages], ',')
        info += this.f_output([this.apa_note]);
        info += "\n";
        return info;

    }


    get output_bib() {
        // 遍历所有的属性，如果 包含''org 字符串，则保留
        let t = `@${this.entryType}{${this.citekey},\n`;
        let UN = BIB[this.entryType]['UN'];
        let NUN = BIB[this.entryType]['UN'] + BIB[this.entryType]['N'];

        for (let key in this) {
            if (key.includes('org_')) {
                //如果 key 在bib 中
                let k = key.replace('org_', '');
                if (!NUN.includes(k)) {
                    continue;
                }
                if (UN.includes(k) && this[key] == '') {
                    continue;
                }
                t += `    ${k} = {${this[key]}},\n`;
            }
        }
        t += '}\n';

        return t;
    }

    get output_bbl() {
        let t = '';
        switch (this.entryType) {
            case 'article':// article: 期刊或杂志上的文章
                return this.article;
            case 'book': // book: 书籍
                return this.book;
            case 'booklet':// booklet: 和book一样，但没有指定的出版商
                return this.booklet;
            case 'inbook':// inbook: 书中的一章或一节
                return this.inbook;
            case 'unpublished':// unpublished: 尚未正式出版的作品
                return this.unpublished;
            case 'manual':// manual: 技术手册
                return this.manual;
            case 'masterthesis':// masterthesis: 硕士论文
                return this.masterthesis;
            case 'phdthesis':// phdthesis: 博士论文
                return this.phdthesis;
            case 'conference':// conference: 会议论文
                return this.conference;
            case 'inproceedings':// inproceedings: 会议论文与 conference 相同
                return this.conference;
            case 'incollection':// incollection: 论文集中的文章
                return this.incollection;
            case 'proceedings':// proceedings: 整个会议记录
                return this.proceedings;
            case 'techreport'://  techreport: 技术报告，政府报告或白皮书
                return this.techreport;
            case 'misc':// misc: 如果没有其他合适的可以使用，则使用 misc，比如网址，邮件等。
                return this.misc;
            case 'patent':// patent: 专利
                return this.misc;
            default:
                return this.misc;
        }
    }
}

function formatbib(bibtxt) {
    //分割bib txt,  以 @ 开头, 以 @ 结尾
    const at_pos = [...bibtxt.matchAll(/@/g)].map(m => m.index);
    let res = at_pos.map((pos, i) => bibtxt.slice(pos, at_pos[i + 1])).filter(x => x !== undefined);

    // 计算元素出现在数组中多少次
    function countOccurrences(arr, val) {
        return arr.reduce((count, item) => {
            return count + (item === val);
        }, 0);
    }

    let biblist = {
        "en": {}, "zh": {}
    };
    let count_list = [];
    let inds = 'abcdefghijklmnopqrstuvwxyz'

    //遍历 res 
    for (let i = 0; i < res.length; i++) {
        var tembib = res[i].split('\n').filter(line => line.trim() !== '' && !line.trim().startsWith('%')).join('\n');

        let t = new anybib(tembib);
        let n = 0;
        //  实现排序,中文按笔画, 英文按字母
        let s = t.apa_citetxt;

        if (t.language == "zh") {
            let num = strokes.indexOf(s[0])
            if (num == -1) { num = 9999; }
            let yearnum = t.year
            if (isNaN(yearnum)) { yearnum = 9999; }
            let numj = `${num}${yearnum}${n}`

            if (biblist['zh'][s] == undefined) {
                biblist['zh'][s] = [numj, '', t];
            } else {
                // 将重复的元素添加到 count_list 中
                count_list.push(s)
                n = countOccurrences(count_list, s);
                numj = `${num}${yearnum}${n}`
                let nn = inds[n]
                // 找出 t.apa_year 字符串的连续4位数字, 并将其替换为 nn
                t.apa_citetxt = nn
                t.apa_year = nn
                biblist['zh'][`${s}${nn}`] = [numj, nn, t];
            }
        } else {
            s = s.toLowerCase();
            let num = strokes.indexOf(s[0])
            let num1 = strokes.indexOf(s[1])
            if (num == -1) { num = 9999; }
            if (num1 == -1) { num1 = 9999; }
            let yearnum = t.year;
            if (isNaN(yearnum)) { yearnum = 9999; }
            let numj = `${num}${num1}${yearnum}${n}`;


            if (biblist['en'][s] == undefined) {
                biblist['en'][s] = [numj, '', t];
            } else {
                // 将重复的元素添加到 count_list 中
                count_list.push(s);
                n = countOccurrences(count_list, s);
                numj = `${num}${num1}${yearnum}${n}`;

                let nn = inds[n]
                // 找出 t.apa_year 字符串的连续4位数字, 并将其替换为 nn
                t.apa_citetxt = nn
                t.apa_year = nn
                biblist['en'][`${s}${nn}`] = [numj, nn, t];
            }
        }
    }
    // count_list 去重
    count_list = [...new Set(count_list)]
    // 遍历 count_list, 如果元素在biblist['zh']的key中, 则是取出值,并删除
    for (let i = 0; i < count_list.length; i++) {
        if (count_list[i] in biblist['zh']) {
            let tem = biblist['zh'][count_list[i]]
            tem[2].apa_citetxt = 'a';
            tem[2].apa_year = 'a';
            biblist['zh'][`${count_list[i]}a`] = [tem[0], 'a', tem[2]]
            delete biblist['zh'][count_list[i]]
        }
        if (count_list[i] in biblist['en']) {
            let tem = biblist['en'][count_list[i]]
            tem[1] = 'a'
            tem[2].apa_citetxt = 'a';
            tem[2].apa_year = 'a';
            biblist['en'][`${count_list[i]}a`] = [tem[0], 'a', tem[2]]
            delete biblist['en'][count_list[i]]
        }
    }

    // biblist['zh'] 按照 value 的第一个元素排序后,并返回第三个元素
    let biblist_zh = Object.entries(biblist['zh']).sort((a, b) => a[1][0] - b[1][0]).map(x => x[1][2])
    let biblist_en = Object.entries(biblist['en']).sort((a, b) => a[1][0] - b[1][0]).map(x => x[1][2])
    // 返回 biblist_zh 值的第三个元素
    return [biblist_zh, biblist_en]
}

function output_bbl(biblist_zh, biblist_en) {
    let zhbbl = [];
    for (let i = 0; i < biblist_zh.length; i++) {
        zhbbl.push(biblist_zh[i].output_bbl);
    }

    let enbbl = [];
    for (let i = 0; i < biblist_en.length; i++) {
        enbbl.push(biblist_en[i].output_bbl);
    }

    let a = `\\bibitem[zh, 2019]{zh2019}{\\fontsize{16pt}{\\baselineskip}\\selectfont{中文部分：}}
    {\\large\\linespread{1.485}\\selectfont 
    
    `
    let b = `}`
    if (zhbbl.length > 0) {
        //  在 zhbbl 数组, 第一个位置上 添加元素
        zhbbl.unshift(a);
        //  在 zhbbl 数组, 最后一个位置上 添加元素
        zhbbl.push(b);
    }

    a = `\\bibitem[En, 2019]{en2019}{\\fontsize{16pt}{\\baselineskip}\\selectfont{英文部分：}}
    {\\normalsize\\linespread{1.08333333333333}\\selectfont
    `
    b = `}`
    if (enbbl.length > 0) {
        enbbl.unshift(a);
        enbbl.push(b);
    }

    let allbll = [zhbbl.join('\n'), enbbl.join('\n')]
    //allbbl 去空元素
    allbll = allbll.filter(line => line.trim() !== '' && !line.trim().startsWith('%'));
    allbll = allbll.join('\n\n\\clearpage\n')
    let bbl = `\\begin{thebibliography}{}\n`
    bbl += allbll
    bbl += `\n\n\\end{thebibliography}`;
    return bbl
}

function output_bib(biblist_zh, biblist_en) {
    let zhbbl = [];
    for (let i = 0; i < biblist_zh.length; i++) {
        zhbbl.push(biblist_zh[i].output_bib);
    }

    let enbbl = [];
    for (let i = 0; i < biblist_en.length; i++) {
        enbbl.push(biblist_en[i].output_bib);
    }
    // zhbbl & enbbl 合并输出字符
    let allbll = [zhbbl.join('\n'), enbbl.join('\n')]
    //allbbl 去空元素
    allbll = allbll.filter(line => line.trim() !== '' && !line.trim().startsWith('%'));
    allbll = allbll.join('\n\n')
    return allbll
}








let bib = `
@article{enart,
    author = {Cole, T. W. and Han, M.-J. and Weathers, W. F. and Joyner, E},
    year = {1992},
    title = {Library marc records into linked open data: Challenges and opportunities},
    journal = {Journal of Library Metadata},
    volume = {13},
    number = {2-3},
    pages = {163-196},
    url = {https://doi.org/10.1080/19386389.20%13.826074},
}

@article{zrt,
    author = {林菁},
    year = {2018},
    title = {國小探究式資訊素養融入課程之研究：理論與實踐},
    journal = {教育資料與圖書館學},
    volume = {55},
    number = {2},
    pages = {103-137},
    url = {https://doi.org/10.6120/JoEMLS.201807\_55(2).0004.RS.CM},
}

@article{zhartoyear,
    author = {陳亞寧 and 温達茂},
    year = {出版中},
    title = {MARC21 鏈結資料化的轉變與應用},
    journal = {教育資料與圖書館學},
    url = {http://joemls.dils.tku.edu.tw/fulltext/57/57-1/Ya-Ning\%20Chen.pdf  },
}

@article{enrt2,
    author = {Milliot, J},
    year = {in press},
    title = {Publishers, printers meet to talk shop},
    journal = {Publishers Weekly},
    volume = {267},
    number = {7},
    pages = {10},
}

@article{zhrt2,
    author = {邱炯友},
    year = {出版中},
    title = {大學出版社與大學圖書館之開放取用(Open Access)政策合作與分享},
    journal = {臺灣出版與閱讀},
    volume = {5},
    pages = {4-7},
}

@article{enart3,
    author = {MacDonald, S},
    year = {2020},
    title = {Ex-Ibrox chief’s huge library heads to home of golf},
    journal = {The Times},
    pages = {18},
}

@article{zhart3,
    author = {何定照},
    year = {2019},
    title = {出版免營業稅案 文化部：正面發展},
    journal = {The Times},
    pages = {18},
}

@book{rbe1,
    author = {Manguel, A},
    title = {The library at night},
    publisher = {Yale University Press},
    year = {2009},
}

@book{rbe2,
    author = {Manguel, A},
    title = {The library at night},
    publisher = {Yale University Press},
    year = {2009},
    volume = {13},
    address = {New Haven, CT},
    series = {open data},
}

@book{rbz1,
    author = {邱炯友 and 林瑺慧},
    title = {學術期刊羅馬化：APA、Chicago（Turabian）與羅馬化引文格式規範},
    publisher = {淡江大學出版中心},
    year = {2014},
}

@book{rbz2,
    author = {邱炯友 and 林瑺慧},
    title = {學術期刊羅馬化：APA、Chicago（Turabian）與羅馬化引文格式規範},
    publisher = {淡江大學出版中心},
    year = {2014},
    volume = {13},
    address = {中国台湾},
    series = {开源数据},
}
 
@incollection{ric1,
    author = {Manguel, A},
    title = {The library at night},
    booktitle = {booktitle name here},
    publisher = {Yale University Press},
    year = {2009},
}

@incollection{ric2,
    author = {Manguel, A},
    title = {The library at night},
    booktitle = {booktitle name here},
    publisher = {Yale University Press},
    year = {2009},
    editor = {editora and tdie},
    volume = {13},
    series = {open data},
    chapter = {chapter name hter},
    edition = {2th},
    address = {uth ut},
}

@incollection{ric3,
    author = {邱炯友 and 林瑺慧},
    title = {學術期刊羅馬化：APA、Chicago（Turabian）與羅馬化引文格式規範},
    booktitle = {章节标题题目},
    publisher = {淡江大學出版中心},
    year = {2014},
}

@incollection{ric4,
    author = {邱炯友 and 林瑺慧},
    title = {學術期刊羅馬化：APA、Chicago（Turabian）與羅馬化引文格式規範},
    booktitle = {书名在这},
    publisher = {淡江大學出版中心},
    year = {2014},
    pages = {3},
    volume = {13},
    series = {开源数据集系列},
    editor = {林瑺慧},
}

@book{enbookdtion,
    author = {Bordwell, D. and Thompson, K},
    title = {Film art: An introduction},
    publisher = {McGraw-Hill Education},
    year = {2013},
    edition = {10th ed., International ed},
}

@book{zhookedtion,
    author = {王震武 and 林文瑛 and 林烘煜 and 張郁雯 and 陳學志},
    title = {心理學},
    publisher = {學富文化},
    year = {2004},
    edition = {修訂版},
}

@book{enboout,
    author = {Harvey, S. and Goudvis, A},
    title = {Strategies that work: Teaching comprehension for understanding and engagement},
    publisher = {Stenhouse Publishers; Pembroke Publishers},
    year = {2007},
    edition = {2nd},
}

@book{zhbookmut,
    author = {文藻外語學院．圖書館團隊},
    title = {圖書館服務英文},
    publisher = {文藻外語學院；Airiti Press},
    year = {2009},
}

@book{enbooktra,
    author = {Bourdieu, P},
    title = {Homo academicus},
    publisher = {Stanford University Press.(Original work published 1968},
    year = {1990},
    edition = {P. Collier, Trans},
}

@book{zhbookra,
    author = {Luey, B},
    title = {學術寫作與出版：從期刊文章、專書、教科書到大眾書},
    publisher = {群學。（原著出版於2009 年},
    year = {2013},
    edition = {陳玉苹譯},
}

@incollection{enookchapter,
    author = {Villazón-Terrazas and Vilches-Blázquez, L. M. and Corcho, O. and Gómez-Pérez},
    title = {Methodological guidelines for publishing government linked data},
    booktitle = {Linking government data},
    publisher = {Springer},
    year = {2011},
    editor = {D. Wood},
    pages = {27-49},
}

@incollection{zhbookchapter,
    author = {邱子恒},
    title = {電 網路資源描述與詮釋資料概論},
    booktitle = {資訊組織},
    publisher = {Airiti Press},
    year = {2017},
    editor = {張慧銖},
    pages = {173-200},
}

@techreport{techreport1,
    author = {Johnson, R. and Watkinson, A and Mabe, M},
    title = {The STM report: An overview of scientific and scholarly publishing},
    institution = {International Association of Scientific, Technical and Medical Publishers},
    year = {2018},
}

@techreport{techreport2,
    author = {林雯瑤},
    title = {學術傳播速度與學術期刊創新機制之關聯性研究},
    institution = {淡江大學資訊與圖書館學系},
    year = {2018},
}

@conference{conference,
    author = {Poff, D. C},
    year = {2019, May 4-7},
    title = {~},
    series = {Diversity/inclusion in research and publication ethics},
    booktitle = {2019 CSE Annual Meeting},
    address = {Columbus, OH, United States},
    pages = {3-33},
}



@conference{zhroceedings2,
    author = {温達茂},
    year = {2015-12-26},
    title = {圖資開放鏈結系統與應用初探},
    series= {圖書資訊學的傳承與創新:教資/資圖45 週年系慶學術研討會},
    booktitle = {Session I 圖資系統的應用發展},
    address = {新北市，台灣},
    editor = {黃鴻珠},
    pages = {研究讨会演讲},
}

@phdthesis{entesis,
    author = {Abdoh, E},
    title = {Implications of social networks on medication information-Seeking among middle eastern international students: An exploratory Study},
    year = {2019},
    school = {University of South Carolina},
}

@mastersthesis{zhthesis,
    author = {林瑺慧},
    title = {台灣學術期刊引用文獻羅馬化現況研究：以TSSCI、THCI Core、A\&HCI、SSCI 及Scopus 收錄期刊為例},
    school = {淡江大學資訊與圖書館學系},
    year = {2014},
}

`

let [biblist_zh, biblist_en] = formatbib(bib)
let bbl = output_bbl(biblist_zh, biblist_en)
let bibt = output_bib(biblist_zh, biblist_en)

console.log(bbl)
console.log(bibt)

